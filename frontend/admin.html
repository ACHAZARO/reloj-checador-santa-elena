<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Panel Gerente – Reloj Checador</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">

  <!-- ───── MODAL LOGIN ───── -->
  <div id="modal" class="fixed inset-0 flex items-center justify-center bg-black/40">
    <div class="bg-white p-6 rounded shadow w-72">
      <h2 class="text-lg font-bold mb-4">Clave de gerente</h2>

      <input id="inpPwd"
             type="password"
             class="border w-full p-1 mb-2"
             placeholder="Contraseña" />

      <label class="text-sm flex items-center mb-3 gap-1 cursor-pointer">
        <input type="checkbox" id="chkShow">
        <span>Mostrar contraseña</span>
      </label>

      <button id="btnLogin"
              class="bg-blue-600 text-white w-full py-1 rounded opacity-50 cursor-not-allowed"
              disabled>Entrar</button>

      <p id="msgErr"  class="text-red-600 text-sm mt-2 hidden">Clave incorrecta</p>
      <p id="msgLoad" class="text-gray-600 text-sm mt-2">Cargando clave…</p>
    </div>
  </div>

  <h1 class="text-2xl font-bold mb-4">Registros del Día</h1>

  <!-- Formulario para alta de empleado -->
  <form id="formNuevoEmpleado" class="p-4 bg-white rounded shadow mb-4">
    <h3 class="text-lg font-bold mb-2">Agregar empleado</h3>
    <div class="mb-2">
      <label class="block font-medium">Nombre</label>
      <input id="inpNombre" type="text" class="border w-full p-1">
    </div>
    <div class="mb-2">
      <label class="block font-medium">PIN</label>
      <input id="inpPin" type="text" class="border w-full p-1">
    </div>
    <div class="mb-2">
      <label class="block font-medium">Sueldo diario</label>
      <input id="inpSalario" type="number" step="0.01" class="border w-full p-1">
    </div>
    <div class="mb-2">
      <label class="block font-medium">Fecha de ingreso</label>
      <input id="inpFecha" type="date" class="border w-full p-1">
    </div>
    <button id="btnAgregarEmpleado" type="button" class="bg-blue-500 text-white px-4 py-2 rounded">Agregar</button>
  </form>

  <div class="mb-4">
    Fecha:
    <input id="fecha" type="date" class="border p-1" />
    <button id="btnCargar" class="bg-blue-600 text-white px-3 py-1 rounded">Cargar</button>
    <button id="btnCSV"   class="bg-green-600 text-white px-3 py-1 rounded ml-2">Descargar CSV</button>
  </div>

  <table id="tbl" class="min-w-full bg-white border">
    <thead>
      <tr class="bg-gray-200">
        <th class="border px-2 py-1">Empleado</th>
        <th class="border px-2 py-1">Entrada</th>
        <th class="border px-2 py-1">Salida</th>
        <th class="border px-2 py-1">Horas</th>
        <th class="border px-2 py-1">Incidencia</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API = 'https://reloj-checador-se.uc.r.appspot.com';

    // Elementos del modal
    const modal    = document.getElementById('modal');
    const inpPwd   = document.getElementById('inpPwd');
    const btnLogin = document.getElementById('btnLogin');
    const chkShow  = document.getElementById('chkShow');
    const msgErr   = document.getElementById('msgErr');
    const msgLoad  = document.getElementById('msgLoad');

    // Muestra mensaje de error
    function showError(text) {
      msgErr.textContent = text;
      msgErr.classList.remove('hidden');
    }
    // Oculta mensaje de error
    function hideError() {
      msgErr.classList.add('hidden');
    }

    // Inicializa proceso de login dinámico
    async function initLogin() {
      const storedKey = localStorage.getItem('gerenteKey');
      if (storedKey) {
        modal.classList.add('hidden');
        return;
      }
      try {
        const res = await fetch(`${API}/api/clave-gerente`);
        if (!res.ok) throw new Error(res.statusText);
        const { valor } = await res.json();
        const claveReal = (valor || '').trim();

        // desbloquea botón
        msgLoad.textContent = '';
        btnLogin.disabled = false;
        btnLogin.classList.remove('opacity-50', 'cursor-not-allowed');

        btnLogin.addEventListener('click', () => {
          hideError();
          if (inpPwd.value.trim() === claveReal) {
            localStorage.setItem('gerenteKey', claveReal);
            modal.classList.add('hidden');
          } else {
            showError('Clave incorrecta');
          }
        });
      } catch (e) {
        msgLoad.textContent = 'Error al cargar clave';
        console.error(e);
      }
    }

    // Toggle mostrar/ocultar contraseña
    chkShow.addEventListener('change', () => {
      inpPwd.type = chkShow.checked ? 'text' : 'password';
    });

    initLogin();

    // ───── FUNCIONES DE REGISTROS ─────
    document.getElementById('btnCargar').onclick = cargar;
    document.getElementById('btnCSV').onclick   = descargarCSV;

    async function cargar() {
      const fecha = document.getElementById('fecha').value;
      const key   = localStorage.getItem('gerenteKey');
      const res   = await fetch(`${API}/api/registros?fecha=${fecha}`, {
        headers: { 'X-Gerente-Key': key }
      });
      const { data } = await res.json();
      pintar(data);
    }

    function pintar(arr) {
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      arr.forEach(r => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td class="border px-2">${r.nombre}</td>
            <td class="border px-2">${fmt(r.hora_entrada)}</td>
            <td class="border px-2">${fmt(r.hora_salida)}</td>
            <td class="border px-2">${r.horas_trabajadas ?? ''}</td>
            <td class="border px-2">${r.incidencia       ?? ''}</td>
          </tr>`);
      });
    }

    function fmt(ts) {
      if (!ts) return '';
      const d = new Date(ts._seconds * 1000);
      return d.toLocaleTimeString('es-MX', { hour:'2-digit', minute:'2-digit' });
    }

    function descargarCSV() {
      const rows = [['Empleado','Entrada','Salida','Horas','Incidencia']];
      document.querySelectorAll('#tbl tbody tr').forEach(tr => {
        rows.push([...tr.children].map(td => td.textContent));
      });
      const blob = new Blob([rows.map(r => r.join(',')).join('\n')], { type:'text/csv' });
      Object.assign(document.createElement('a'), {
        href: URL.createObjectURL(blob),
        download: 'registros.csv'
      }).click();
    }

    // ───── ALTA DE EMPLEADOS ─────
    const btnAgregarEmpleado = document.getElementById('btnAgregarEmpleado');
    if (btnAgregarEmpleado) {
      btnAgregarEmpleado.addEventListener('click', async () => {
        const nombre       = document.getElementById('inpNombre').value.trim();
        const pin          = document.getElementById('inpPin').value.trim();
        const salarioDiario= document.getElementById('inpSalario').value.trim();
        const fechaIngreso = document.getElementById('inpFecha').value.trim();
        if (!nombre || !pin || !salarioDiario) {
          alert('Llena todos los campos obligatorios');
          return;
        }
        try {
          const res = await fetch(`${API}/api/empleados`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre, pin, salarioDiario, fechaIngreso })
          });
          if (res.ok) {
            alert('Empleado creado correctamente');
            document.getElementById('formNuevoEmpleado').reset();
          } else {
            const data = await res.json();
            alert('Error: ' + (data.error || 'No se pudo crear'));
          }
        } catch (err) {
          alert('Error al conectar con el servidor');
        }
      });
    }
  </script>
</body>
</html>
